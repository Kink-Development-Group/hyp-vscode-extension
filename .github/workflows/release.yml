name: Release HypnoScript Extension

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ” Compile TypeScript
        run: npm run compile

      - name: ğŸ“¦ Package VSCode Extension
        run: npx vsce package

      - name: ğŸ—ƒï¸ Erfasse VSIX-Artefakt
        id: artifact
        run: |
          VSIX_FILE=$(find . -maxdepth 1 -type f -name '*.vsix' -print -quit)
          if [ -z "$VSIX_FILE" ]; then
            echo "âŒ Keine VSIX-Datei gefunden" >&2
            exit 1
          fi
          VSIX_FILE="${VSIX_FILE#./}"
          echo "vsix=$VSIX_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ” Check if Release Exists
        id: check_release
        run: |
          if gh release view ${{ github.ref_name }} &>/dev/null; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Release already exists for ${{ github.ref_name }}"
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… No existing release found for ${{ github.ref_name }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—‚ï¸ Upload Artifact to GitHub Releases
        if: steps.check_release.outputs.release_exists != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.artifact.outputs.vsix }}
          tag_name: ${{ github.ref }}
          body: "ğŸš€ New release of HypnoScript Extension!"
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Aktualisiere bestehendes Release
        if: steps.check_release.outputs.release_exists == 'true'
        run: |
          gh release upload ${{ github.ref_name }} "${{ steps.artifact.outputs.vsix }}" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Publish to VSCode Marketplace
        run: npx vsce publish -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
